<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
    <title>サンプル 予定変更の申請フォーム</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
    <link rel="stylesheet" href="js/samplestyle.css">
</head>
<body>

<form class="w-75 mx-auto" id="order">
<label class="mt-3"><big><big>予定変更の申請フォーム</big></big></label>
	<p class="mt-3"><span class="itemLine"><big>児童名</big></span></p>
	<p><span id="name"></span></p>
	<p class="mt-3"><span class="itemLine"><big>変更内容</big></span></p>
<div>
<select class="form-control w-100 mt-1" name="genre" id="genre" require>
	<option disabled selected>選択して下さい</option>
	<option value="reserve">利用日の追加</option>
	<option value="cancel">利用日のキャンセル</option>
	<option value="change">利用時間の変更</option>
</select>
</div>
	<p class="mt-3"><span class="itemLine"><big>希望年月日</big></span><font color="red"><small>  *当日 ～ 30日後の範囲内まで</small></font></p>
<div>
<input type="text" class="form-control w-100 mt-1" name="datepick" id="datepicker" placeholder="タップしてください" readonly/>
</div>
<div id="timesDiv">
	<p class="mt-3"><span class="itemLine"><big>希望時刻</big></span></p>
	<font color="red"><small>  *送迎を希望される場合、ご指定の時間や場所に応じられない場合があります。</small></font>
<p class="mt-3"><span class="itemLine2">来所時刻</span>
	<input type="time" class="form-control w-40 mt-1" name="starttime" id="scheduled-time" value="15:00" min="08:30" max="16:00" disabled/></p>
	<p class="mt-3"><input type="checkbox" name="afterschool" id="afterSchool" value="afterSchool" checked="checked" disabled/><label for="afterSchool">下校後来所(学校の下校時間に準じます。)</label></p>
	<p class="mt-3"><input type="checkbox" name="scar" id="sCar" value="sCar" disabled /><label for="sCar">迎え希望</label></p>
	<div id="fromDiv">
	<p class="mt-3">迎えの場所：
	<select class="form-control w-100 mt-1" name="fromselect" id="fromSelect">
	<option value="fromSchool" selected>学校</option>
	<option value="fromHome">自宅</option>
	<option value="fromSomewhere">その他</option>
	</select>
	</p>
	</div>
	<div id="fromWhere">
	<div class="errorDiv" id="fromError">半角記号は入れないで下さい。</div>
	<div class="errorDiv" id="fromNotPlace">「その他」を選択した場合、記入欄に場所名を記入して下さい。</div>
	記入欄<input tyle="text" name="fname" id="fName" placeholder="分かりやすい場所名を記入" />
	</div>
	<br>
<p class="mt-3"><span class="itemLine2">退所時刻</span>
	<input type="time" class="form-control w-40 mt-1" name="endtime" id="end-time" value="16:00" min="11:00" max="18:00" disabled/></p>
	<p class="mt-3"><input type="checkbox" name="ecar" id="eCar" value="eCar" disabled /><label for="eCar">送り希望</label></p>
	<div id="toDiv">
	<p class="mt-3">送りの場所：
	<select class="form-control w-100 mt-1" name="toselect" id="toSelect">
	<option value="toHome" selected>自宅</option>
	<option value="toSomewhere">その他</option>
	</select>
	</p>
	</div>
	<div id="toWhere">
	<div class="errorDiv" id="toError">半角記号は入れないで下さい。</div>
	<div class="errorDiv" id="toNotPlace">「その他」を選択した場合、記入欄に場所名を記入して下さい。</div>
	記入欄<input tyle="text" name="tname" id="tName" placeholder="分かりやすい場所名を記入" />
	</div>
</div>
	<p class="mt-3"><span class="itemLine"><big>その他(自由記載)</big></span></p>
	<div class="errorDiv" id="textError">半角記号は入れないで下さい。</div>
<textarea id="textarea" name="memo" maxlength="100" rows="8" cols="40" placeholder="変更の理由や、送迎についてのご相談等がありましたら、ご記入ください。（100文字以内）"></textarea>
<p id="count">あと<span id="num"></span>文字</p>
<input type="submit" id="submit" class="mt-4 btn btn-primary" value="送信" disabled>	<input type="button" id="cancel" class="mt-4 btn" value="キャンセル" >
</form>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="js/datepicker-ja.js"></script>
<script src="https://cdn.rawgit.com/osamutake/japanese-holidays-js/v1.0.10/lib/japanese-holidays.min.js"></script>
<script charset ="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script charset ="utf-8" src="js/initialize.js"></script>
<script>
const time = document.getElementById('scheduled-time');
const e_time = document.getElementById('end-time');
const select_type = document.getElementById('genre');
const afterSchool = document.getElementById('afterSchool');
const startCar = document.getElementById('sCar');
const endCar = document.getElementById('eCar');
const timesDiv = document.getElementById('timesDiv');
select_type.onchange = () => {
	if(select_type.selectedIndex == 1 || select_type.selectedIndex == 3){
		timesDiv.style.display = "block";
		//time.disabled = false;
		e_time.disabled = false;
		afterSchool.disabled = false;
		startCar.disabled = false;
		endCar.disabled = false;
	}else{
		timesDiv.style.display = "none";
		time.disabled = true;
		e_time.disabled = true;
		afterSchool.disabled = true;
		startCar.disabled = true;
		endCar.disabled = true;
	}
}

afterSchool.addEventListener('click', (e) => {
	if(afterSchool.checked == true) time.disabled = true;
	/*
	else{
		(sCar.checked == true) ? time.disabled = true : time.disabled = false;
	}
 	*/
});

const fromDiv = document.getElementById("fromDiv");
startCar.addEventListener('click', (e) => {
	if(startCar.checked == true){
		fromDiv.disabled = false;
		fromDiv.style.display = "block";
	}else{
		fromDiv.disabled = true;
		fromDiv.style.display = "none";
	}
});

const toDiv = document.getElementById("toDiv");
endCar.addEventListener('click', (e) => {
	if(endCar.checked == true){
		toDiv.disabled = false;
		toDiv.style.display = "block";
	}else{
		toDiv.disabled = true;
		toDiv.style.display = "none";
	}
});	

const today = new Date();
const date = document.getElementById('datepicker');
$('#datepicker').datepicker({
	numberOfMonths:1,
	dateFormat:'yy/mm/dd',
	minDate:today,
	maxDate:'+1m',
	beforeShowDay: function(input){
		let holiday = JapaneseHolidays.isHoliday(input);
		if (input.getDay() == 0 || holiday) {
			return [false, "ui-state-disabled"];
		}else if(input.getDay() == 6){
			const tempYear = input.getFullYear();
			const tempMonth= input.getMonth();
			let wc = 0;
			let rw = [];
			for(let i=1; i<=31; i++){
				const tmpDate = new Date(tempYear, tempMonth, i);
				//if(tempMonth != tmpDate.getMonth()) break;
				if(tmpDate.getDay() != 6) continue;
				wc = wc+1;
				if(wc%2 == 0) rw.push(tmpDate);
			}
			for(let i=0; i<rw.length; i++){
				if(rw[i].getDate() == input.getDate()) return [false, "ui-state-disabled"];
			}
			return [true, "calender-saturday", ""];
		}else{
			return [true, ""];
		}
	}
});

const textarea = document.getElementById('textarea');
const maxText = 100;
textarea.onkeyup = () => {
	let c_count = textarea.value.length;
	let limitChar = maxText - c_count;
	$('#num').text(limitChar);
}

const order = document.getElementById('order');
const submit = document.getElementById('submit');
const fromSelect = document.getElementById('fromSelect');
const fromWhere  = document.getElementById('fromWhere');
const toSelect = document.getElementById('toSelect');
const toWhere  = document.getElementById('toWhere');
order.onchange = () => {
	if(select_type.selectedIndex !== 0 && date.value !== ""){
		submit.disabled = false;
	}else{
		submit.disabled = true;
	}
	if(startCar.checked === true && fromSelect.selectedIndex === 2){
		fromWhere.style.display = "block";
	}else fromWhere.style.display = "none";
	if(endCar.checked === true && toSelect.selectedIndex === 1){
		toWhere.style.display = "block";
	}else toWhere.style.display = "none";
}

const regex = new RegExp('[!-/:-@¥[-`{-~]+', 'g');
const fromError = document.getElementById("fromError");
const toError = document.getElementById("toError");
const textError = document.getElementById("textError");
document.getElementById('submit').addEventListener('click', () => {
	let errCount = 0;
	if(fromSelect.selectedIndex===2 && startCar.checked === true){
		if(fromWhere.value===""){
			fromNotPlace.style.display = "block";
			errCount = 1;
		}else fromNotPlace.style.display = "none";
		if(regex.test(fromWhere.value)){
			fromError.style.display = "block";
			errCount = 1;
		}else fromError.style.display = "none";
	}else{
		fromError.style.display = "none";
		fromNotPlace.style.display = "none";
	}
	if(toSelect.selectedIndex===1 && endCar.checked === true){
		if(toWhere.value===""){
			toNotPlace.style.display = "block";
			errCount = 1;
		}else toNotPlace.style.display = "none";
		if(regex.test(toWhere.value)){
			toError.style.display = "block";
			errCount = 1;
		}else toError.style.display = "none";
	}else{
		toError.style.display = "none";
		toNotPlace.style.display = "none";
	}
	if(regex.test(textarea.value)){
		textError.style.display = "block";
		errCount = 1;
	}else textError.style.display = "none";
	if(errCount > 0){
		window.alert("記入内容に誤りがあります。");
		event.preventDefault();
	}
	if(window.confirm('この内容で申請して宜しいですか？')) return true;
	else event.preventDefault();
}, false);

document.getElementById('cancel').addEventListener('click', () => {
	if(window.confirm('申請を中断しますか？')) liff.closeWindow();
	else event.preventDefault();
});
</script>

</body>
</html>
